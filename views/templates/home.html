
<div class="panel panel-danger">
  <div class="panel-heading"><strong>Bills are not synchronized </strong>
  </div>

  <div class="panel-body"><!-- 
  <div class="loader" style = "border-left: 60px;"></div> -->
    Press generate if all the bills are ready to be uploaded to the system
    <strong>Last time populated April </strong>
    <button type="button" class="btn btn-danger" id="filepicker">Populate</button>
    
  </div>
</div>
<div class="panel panel-danger">
  <div class="panel-heading"><strong>No Bills were sent to employees</strong></div>
  <div class="panel-body">Press the send button to send each bill to each employee
    <strong>Last time sent April </strong>
    <button type="button" class="btn btn-danger" id="sendMails">Send</button></div>
</div>






<script>


// require('../renderer.js');

$('.loader').hide()

var $     = require( 'jquery' ); 
var mysql = require('mysql');

var connection = mysql.createConnection({
    host     : 'mysql.qatar.cmu.local',
    user     : 'fmbills_devuser',
    password : 'PatUmNed', // or the original password : 'apaswword'
    database : 'fmbills_dev',
    insecureAuth: true
});



// connect to mysql
connection.connect(function(err) {
    // in case of error
    if(err){
        console.log(err.code);
        console.log(err.fatal);
    }
});




function addBill(billNo, pastBalance, paymentsReceived, totalAmountDue, billDate, billPeriod, deadline, pdfURL, landLine){
    $query = "INSERT INTO `bill` VALUES ('"+ billNo + "','"+ pastBalance +"', '"+ paymentsReceived +"', '"+ totalAmountDue+"', '"+ billDate+"', '"+ billPeriod+"', '"+ deadline +"', '"+ pdfURL+"', '"+ landLine+"');";
    
    connection.query($query, function(err, rows, fields) {
        if(err){
            if (err.toString().substr(0,19) == "Error: ER_DUP_ENTRY"){
                // alert("Bill Number " + billNo + " already exists in the database!")
            }
            else{
                alert(err.toString() + "\n" + landLine);
            }
            // console.log("An error ocurred performing the query.");
            // console.log(err);
            return 0;
        }
        return 1
    });
}



const {remote} = require('electron');

var fs = require('fs');

const path = require('path');


//********************************************************** dialog box ************************************************//


var direc;

var filepicker = document.getElementById('filepicker');
if (filepicker != null)
filepicker.onclick = openSelection;

//*********************************************************Code For dialogbox ***************************************//
function openSelection(){



  var countBillAdded = 0;
  var countBillSkipped = 0;
  var countEnd = 0;
  // const dialog = require('electron').remote.dialog;
  const dialog = remote.getGlobal('dialog');
  var a = dialog.showOpenDialog({ properties: ['openDirectory']});
  // $("#filepicker").hide()
  // $(".loader").show()
  // if (direc == undefined){
  //   return;
  // }
  direc = a[0];
  //document.write(direc);

  //Call back to go through every file in the selected directory
  fs.readdir(direc, (err, dir) => {
    

    for(let filePath of dir){
      
      var pathtopdf = direc + '/' + filePath;
      var pathforadding = pathtopdf;

      //Converts it into a proper path
      pathtopdf = path.win32.normalize(pathtopdf);

      //Calls the pdf Reading function
      var check = readPDF(pathtopdf, pathforadding);

      if (check == 0){
        countBillSkipped += 1
      }else{
        countBillAdded += 1
      }

    }

  });
  // $(".loader").hide()
  // $("#filepicker").show()
}

//Requirements 
var pdfText = remote.getGlobal('pdfText');
var fs = require('fs');

//Function to read the pdf
function readPDF(pathtopdf, pathforadding){

  //Creates a buffer stream out of the pdf for faster performance
  var buffer = fs.readFileSync(pathtopdf);

  //callback to extract pdf data
  pdfText(buffer, function(err, chunks) {
    if (err){
      console.log(err)
      console.dir(err);
      return 0;
    }

    //Function call to extract individual/required items 
    return extractData(chunks, pathforadding);
    //console.dir(chunks);

  });
}

//Variable declaration 
var bill_no, landline, past_balance, payments_rec, total_amount, bill_date, bill_period, payment_deadline, pdf_URL;
var total_lines = 1;
var QR_starter_position;

//Individual data extraction
function extractData(chunks, pdfPath){

  var cust_no = chunks[5];
  if (cust_no == "02666714"){

    //Extract Bill number
    bill_no = chunks[9];
    console.log("Bill Number: ", bill_no);

    //Extract Bill date
    bill_date = chunks[11];
    // console.log("Bill Date: ", bill_date);

    //Extract Bill number
    bill_period = chunks[13];
    // console.log("Bill Period: ", bill_period);

    //Extract PDF URL
    pdf_URL = pdfPath
    // console.log("PDF URL: ", pdf_URL);

    //Extract Landline number
    landline = getLandline (chunks);
    // console.log("Landline Number: ", landline);

    //Extract Past Balance
    past_balance = getPastBalance(chunks);
    // console.log("Past Balance: ", past_balance);

    //Extract Payments Received
    payments_rec = chunks[QR_starter_position + 5];
    payments_rec = parseFloat(payments_rec.replace(',', ''));
    // console.log("Payments Received: ", payments_rec);

    //Extarct Total Value
    total_amount = chunks[QR_starter_position + 18];
    total_amount = parseFloat(total_amount.replace(',', ''));
    // console.log("Total Amount: ", total_amount);

    //Extract Date Deadline
    payment_deadline = chunks[QR_starter_position + 22];
    // console.log("Payment Deadline Date: ", payment_deadline);


    // console.log("\n\n");


    return addBill(bill_no, past_balance, payments_rec, total_amount, bill_date, bill_period, payment_deadline, pdf_URL.replace(/\\/g,"/"), landline);
  }

  else{
    alert("Bogus bill found with this Customer Number " + cust_no + ".\nSkipped!!!");
    return 0;
  }
}

function getPastBalance(chunks){

  var difference = total_lines + 1;
  var start_point = 14 + difference;

  while(!chunks[start_point].includes("QR")) {
    start_point++;
  }

  QR_starter_position = start_point + 1;

  var out = chunks[QR_starter_position + 2];

  out = parseFloat(out.replace(',', ''));
  return out;

}

function getLandline(chunks){
  var fixed_val = 14;
  var alter = fixed_val;

    var bool = false;

  while (bool == false){
    if (chunks[alter].includes("MELLON") || chunks[alter].includes("CARNEGIE") || chunks[alter].includes("GARNEGIE") || chunks[alter].includes("CARNEGEI") || chunks[alter].includes("MELON") || chunks[alter].includes("NEGIE") || chunks[alter].includes("QATAR")|| chunks[alter].includes("CAMPUS"))
    {
        bool = true;
    }
    if (bool == false){
        alter++;
    }
  }

  total_lines = alter - fixed_val - 1;
  var pointer = fixed_val + total_lines;

  if (chunks[pointer].length == 8){
    return chunks[pointer];
  }

  else if (chunks[pointer].length > 8) {
    var val = chunks[pointer].slice((chunks[pointer].length - 8), chunks[pointer].length);
    return val;
  }

  else if (chunks[pointer].length < 8){
    var endVal = chunks[pointer];
    var startVal = chunks[pointer - 1].slice((chunks[pointer - 1].length - (8 - endVal.length)), chunks[pointer - 1].length);
    var out = startVal + endVal;
    return out;
  }
}






///////////// SENDING MAILS


$("#sendMails").click(function(){
  startSending( function(err,data){
          if (err) {
              // error handling code goes here
              console.log("ERROR : ",err);            
          } else {            
              // code to execute on data retrieval
            for (i = 0; i<data.length; i++){
              sendMail(data[i].empName, data[i].landLine, data[i].compName, data[i].pdfUrl)
            }  
          }    

  });
});


// var sendMails = document.getElementById('sendMails');
// sendMails.onclick = 


function startSending(callback){

  var monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  var a = new Date();
    $query = "SELECT CONCAT_WS(' ', `employee`.`firstName`, `employee`.`lastName`) AS `empName`, `housing`.`landLine`, `compound`.`compName`, `bill`.`pdfUrl` from `bill`, `employee`, `housing`, `compound`, `assignment` WHERE `bill`.`landLine` = `housing`.`landLine` AND `housing`.`compId` = `compound`.`compId` AND `housing`.`landLine` = `assignment`.`landLine` AND `employee`.`andrewId` = `assignment`.`andrewId` AND date_format(str_to_date(`bill`.`billDate`, '%d %M %Y'), '%M') = '" + monthNames[3] + "';";
    
    connection.query($query, function(err, rows, fields) {
        if(err){
            // alert(err.toString());
            // return;
            callback(err, null)
        }
        else{
          console.log(rows[0].pdfUrl)
          callback(null, rows)
        }


        // for (item in rows){
        //   sendMail(item.empName, item.landLine, item.compName, item.pdfUrl)
        // }


        // console.log(rows)
    });
}










const nodemailer = require('nodemailer');
var hbs = require('nodemailer-express-handlebars')
// create reusable transporter object using the default SMTP transport
let transporter = nodemailer.createTransport({
    host: 'smtp.qatar.cmu.edu',
    pool: true,
    port: 25,
    ignoreTLS: true,
    secure: false, // secure:true for port 465, secure:false for port 587

});



transporter.use('compile',hbs({
  viewPath: 'emailTemplates',
  extName: '.hbs'
}))




function sendMail(empName, landLine, compName, pdfUrl){
  // setup email data with unicode symbols
  let mailOptions = {
      from: '"Ooredoo Bill" <no-reply-fmbills@qatar.cmu.edu>', // sender address
      to: 'yasirk@qatar.cmu.edu', // list of receivers
      subject: 'Ooredoo Bill Cycle', // Subject line
      template: 'yourBill',
      attachments: [
      {   
          path: pdfUrl
      }
      ],
      context: {
        empName: empName,
        landLine: landLine,
        compName: compName
      }
    };



  // send mail with defined transport object
  transporter.sendMail(mailOptions, (error, info) => {
      if (error) {
          return console.log(error);
      }
      console.log('Message %s sent: %s', info.messageId, info.response);
  });
}


</script>
